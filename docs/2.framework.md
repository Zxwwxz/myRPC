# 二、微服务架构

##服务注册和发现
    客户端：客户端查询调用
    服务端：客户端-》ELB查询调用
    注册中心：etcd，分布式一致性系统，基于raft
    
##Raft算法
    http://thesecretlivesofdata.com/raft/
    场景：解决分布式一致性，基于复制
    工作机制：leader选举，日志复制，安全性
    角色：follower追随者，leader领导，candicate候选人
    任期：时间分为一个个任期，没有Leader不能写入，系统无法使用
    复制状态机：每个节点状态一致，执行相同命令序列（日志），最终一致
    定时器：选举定时器（follower-》Candicate的等待时间，随机的），心跳定时器（成为Leader开启心跳定时器，给Follower发送消息，Follower收到会重置选举定时器）
    选举：
        触发条件：Follower选举定时器超时，过程：选举定时器超时成为Candidate，任期+1，为自己投票，发起rpc要求其他节点为自己投票，超过半数成为Leader，选举超时，进入下一任期。
        限制条件：一个任期一个节点只能投一次票，投票会对比Candidate与自己的log和任期谁更新
    日志复制：
        写入命令只能交给Leader
        追加到本地日志
        复制日志到其他节点，Follower也会写入到日志中，直到所有节点保存
        提交命令，返回客户端状态
        通过下一次心跳通知其他Follower提交
    安全性：
        收到大多数才能当选
        有更新的拒绝投票，不能当选
        当选一定包含所有提交日志
        脑裂：两个Leader，原来的Leader不能提交数据，等网络通了，复制新Leader数据，变成Follower
         
##调用
    数据传输：json，thrift，protobuf
    负载均衡：随机，轮询，一致性hash
    容错：健康检查，熔断，限流
     
##监控  
    日志收集-》数据处理-》日志报警